<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
</head>

<body>
    <div id="notifBox"></div>

    <div class="header">
        <h1 id="username">Halo, ...</h1>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="card">
        <div class="section-title">
            Ringkasan Bulan Ini (<span id="month"></span>)
        </div>

        <p>Pemasukan: <b id="income">Rp 0</b></p>
        <p>Pengeluaran: <b id="outcome">Rp 0</b></p>
        <p>Sisa Saldo: <b id="balance">Rp 0</b></p>
    </div>

    <div class="card">
        <div class="section-title">Input Transaksi Baru</div>

        <div>
            <label>Nominal:</label><br />
            <!-- âš ï¸ WAJIB TANPA TITIK -->
            <input type="number" id="amount" placeholder="Contoh: 300000" />
        </div>

        <div>
            <label>Tanggal:</label><br />
            <input type="date" id="date" />
        </div>

        <div>
            <label>Status:</label><br />
            <select id="status">
                <option value="INCOME">Pemasukan</option>
                <option value="OUTCOME">Pengeluaran</option>
            </select>
        </div>

        <div>
            <label>Keterangan:</label><br />
            <input type="text" id="description" placeholder="Opsional" />
        </div>

        <button onclick="tambahTransaksi()">Tambah Transaksi</button>
    </div>

    <div class="card">
        <div class="section-title">Riwayat Transaksi</div>
        <ul id="riwayat"></ul>
    </div>

<script>
/* ================= AUTH ================= */
async function logout() {
    await fetch("/api/logout", { method: "POST", credentials: "include" });
    location.href = "/login";
}

async function loadUser() {
    const res = await fetch("/api/me", { credentials: "include" });
    const data = await res.json();
    if (!data.success) location.href = "/login";
    document.getElementById("username").innerText =
        "Halo, " + data.user.username;
}
loadUser();

/* ================= DASHBOARD ================= */
async function loadDashboard() {
    const res = await fetch("/api/transactions", { credentials: "include" });
    const data = await res.json();
    if (!data.success) return;

    document.getElementById("month").innerText =
        new Date().toLocaleString("id-ID", { month: "long", year: "numeric" });

    let income = 0, outcome = 0;
    const riw = document.getElementById("riwayat");
    riw.innerHTML = "";

    data.transactions.forEach((t) => {
        const nominal = Number(t.nominal);
        const tanggal = new Date(t.transactionDate)
            .toLocaleDateString("id-ID");

        if (t.status === "INCOME") income += nominal;
        else outcome += nominal;

        const li = document.createElement("li");
        li.innerHTML = `
            <b>[${t.status}]</b> ${tanggal} : Rp ${nominal.toLocaleString("id-ID")}<br>
            ${t.description || ""}
        `;
        riw.appendChild(li);
    });

    document.getElementById("income").innerText = "Rp " + income.toLocaleString("id-ID");
    document.getElementById("outcome").innerText = "Rp " + outcome.toLocaleString("id-ID");
    document.getElementById("balance").innerText =
        "Rp " + (income - outcome).toLocaleString("id-ID");
}
loadDashboard();

/* ================= TAMBAH KE UI ================= */
function tambahKeRiwayatLangsung({ amount, date, status, description }) {
    const riw = document.getElementById("riwayat");
    const nominal = Number(amount);
    const tanggal = new Date(date).toLocaleDateString("id-ID");

    const li = document.createElement("li");
    li.innerHTML = `
        <b>[${status}]</b> ${tanggal} : Rp ${nominal.toLocaleString("id-ID")}<br>
        ${description || ""}
    `;
    riw.prepend(li);

    let income = Number(document.getElementById("income").innerText.replace(/\D/g, ""));
    let outcome = Number(document.getElementById("outcome").innerText.replace(/\D/g, ""));

    if (status === "INCOME") INCOME += nominal;
    else outcome += nominal;

    document.getElementById("income").innerText = "Rp " + income.toLocaleString("id-ID");
    document.getElementById("outcome").innerText = "Rp " + outcome.toLocaleString("id-ID");
    document.getElementById("balance").innerText =
        "Rp " + (income - outcome).toLocaleString("id-ID");
}

/* ================= TAMBAH TRANSAKSI (FIX TOTAL) ================= */
async function tambahTransaksi() {
    const amountEl = document.getElementById("amount");
    const dateEl = document.getElementById("date");
    const statusEl = document.getElementById("status");
    const descEl = document.getElementById("description");

    const amount = amountEl.value;
    const date = dateEl.value;

    // VALIDASI
    if (!amount) {
        showNotif("Nominal wajib diisi!", "error");
        return;
    }

    if (isNaN(amount) || Number(amount) <= 0) {
        showNotif("Nominal harus berupa angka yang valid!", "error");
        return;
    }

    if (!date) {
        showNotif("Tanggal wajib diisi!", "error");
        return;
    }

    const res = await fetch("/api/transaction/add", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            amount: Number(amount),
            date,
            status: statusEl.value,
            description: descEl.value,
        }),
    });

    // ðŸ”¥ AMAN: JANGAN LANGSUNG res.json()
    let data;
    const text = await res.text();

    try {
        data = JSON.parse(text);
    } catch (e) {
        console.error("Response bukan JSON:", text);
        showNotif("Response server tidak valid", "error");
        return;
    }

    if (!data.success) {
        showNotif(data.message || "Gagal menambahkan transaksi", "error");
        return;
    }

    // TAMPIL LANGSUNG
    tambahKeRiwayatLangsung({
        amount,
        date,
        status: statusEl.value,
        description: descEl.value,
    });

    showNotif("âœ… Transaksi berhasil ditambahkan");

    amountEl.value = "";
    dateEl.value = "";
    descEl.value = "";
}

/* ================= NOTIF ================= */
function showNotif(message, type = "success") {
    const box = document.getElementById("notifBox");
    const div = document.createElement("div");

    div.innerText = message;
    box.style.position = "fixed";
    box.style.top = "10px";
    box.style.right = "10px";

    div.style.padding = "10px";
    div.style.marginBottom = "5px";
    div.style.borderRadius = "5px";
    div.style.color = "white";
    div.style.background = type === "success" ? "#2ecc71" : "#e74c3c";

    box.appendChild(div);

    setTimeout(() => div.style.opacity = "0", 2000);
    setTimeout(() => div.remove(), 2600);
}
</script>
</body>
</html>
